
PSV009-FD-004 – Загрузка и обновление прайс-листов 
=================================================================
Проект	Внедрение Microsoft Dynamics AX 2012 R3 и IBM Cognos TM1 в Издательстве «Просвещение»
Процесс	WEB-INT-04 Интеграция с учетной системой 1С: Загрузка данных
ФО	Интернет-магазин
Руководитель группы	Петров А.В.
Администратор процесса	WEB-INT-04 – Логинова С.Г.

+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Алгоритмы
Задача импорта (плагин «Импорт цен»)
•	На форме «Планировщик задач» (Панель управления \ Система \ Планировщик задач) создать новую задачу «Импорт цен» с возможностью запуска в автоматическом режиме, заполнив поля следующим образом: 
Поле	Значение
Название	Импорт цен
Секунды (период запуска)	3600
Включено	Да
Остановка при ошибке 	Нет
•	При удалении плагина выполнять удаление данного задания 
Реализация импорта (плагин «Импорт цен»)
•	Реализовать работу периодической операции «Импорт цен», запускаемую из формы «Планировщик задач» (Панель управления \ Система \ Планировщик задач) следующим образом:
o	Выполнить подключение к базе данных по ODBC-соединению, логину и паролю, которые указаны в одноименных полях настройки плагина к промежуточной базе обмена с интернет-магазином.
o	Выбрать все записи из таблицы MsgTable, для которых выполнено следующее:
	MsgTable.MsgType = PriceEC
	MsgTable.Source= 1C
	MsgTable.Destination = EC
	MsgTable.Status = Exported или MsgTable.Status = ImportedError 
o	Отсортировать все такие записи в порядке возрастания MsgId
o	Последовательно перебирать каждую из указанных выше записей, обрабатывая ее следующим образом:
	Выбрать из таблицы PriceTable все записи с указанным MsgId
	Отобрать на стороне интернет-магазина все записи из таблицы Product по полю SKU.
	Последовательно обрабатывать все записи с указанным MsgId
	Если запись по коду товара ItemId найдена в таблице Product в поле SKU, то выполнить обновление цены в поле Price из одноименного поля таблицы PriceTable.
	Если запись не найдена, то записать количество ошибочных записей.
	Получить список исключений, которые есть на в таблице Product, но нет в таблице PriceTable промежуточной базы обмена (пересекать множества по полю PriceTable.ItemId = Product.SKU). У всего полученного списка установить признак Product.Published = 0 для всех таких записей.
	После обработки всех записей для данного MsgId обновить поле Status в таблице MsgTable для данной записи значением ImportedOk в случае, если ошибок не было, или если ошибки возникли ImportedError. Дальнейшие записи при возникновении ошибки не обрабатывать. 
	В конце создать запись лога в форме «Журнал» (Панель управления \ Система \ Журнал), заполняя поля следующим образом:
Поле	Значение
Уровень записи 	Ошибка – в случае ошибки загрузки
Информация – в случае, если ошибок не было
Краткое сообщение	Ошибка загрузки прайс листа + MsgId – в случае ошибки
Прайс лист загружен + MsgId – в случае успешной загрузки
Полное сообщение 	Всего записей к загрузке %1 (где %1 количество записей к загрузке для данного MsgId). Записей загружено %2 (где %2 количество загруженных записей). Записей с ошибкой %3 (где %3 количество записей, которые не удалось загрузить по причине ошибки).
Дата создания	Заполнить датой и временем окончания импорта
•	Перейти к обработке следующей записи MsgId.
 
